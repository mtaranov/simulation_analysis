* CALCULATE X Y Z FOR BOND VECTORS OVER TRAJECTORY
* CALCULATE C(t) FOR SPECIFIED BOND VECTOR
*

BOMLEV -2



! LOAD TOPOLOGY FILE
OPEN READ CARD UNIT 10 NAME /Users/gavinbas/Work/toppar/TOP_ALL27_PROT_NA.RTF
READ RTF CARD UNIT 10
CLOSE UNIT 10

!LOAD PARAMETER FILE
OPEN READ CARD UNIT 11 NAME /Users/gavinbas/Work/toppar/PAR_ALL27_PROT_NA.PRM
READ PARAMETER CARD UNIT 11
CLOSE UNIT 11

!READ IN PSF
OPEN READ CARD UNIT 14 NAME @PSF/@PSF.PSF
READ PSF CARD UNIT 14
CLOSE UNIT 14

! READ IN COORDINATES
OPEN READ CARD UNIT 14 NAME @PSF/@COR.COR
READ COORDINATES CARD UNIT 14
CLOSE UNIT 14

COOR COPY COMP



IF @CTYPE .EQ. C1P THEN
		SET CTYPE C1'
		SET HTYPE H1'
ENDIF

! DEFINE BACKBONE ATOMS
! ---------------------
!DEFINE LOWER SELECT (SEGID @SEGID .AND. (RESID 1:5 .OR. RESID 23:29) .AND. (.NOT. TYPE H*)) SHOW END
!DEFINE UPPER SELECT (SEGID @SEGID .AND. (RESID 10:12 .OR. RESID 19:21) .AND. (.NOT. TYPE H*)) SHOW END

OPEN UNIT 07 READ UNFORMATTED NAME @DCD.DCD


CORREL MAXSERIES 16 MAXTIMESTEPS 4439 MAXATOMS 12

SET C @RESNAME
SET D @RESID
ENTER @D8X VECT X @SEGID @D @HTYPE @SEGID @D @CTYPE
ENTER @D8Y VECT Y @SEGID @D @HTYPE @SEGID @D @CTYPE
ENTER @D8Z VECT Z @SEGID @D @HTYPE @SEGID @D @CTYPE
ENTER @D8D ZERO
ENTER @D8E ZERO
ENTER @D8F ZERO
ENTER @D8A ZERO
ENTER @D8B ZERO
ENTER @D8C ZERO
ENTER @D8R VECT R @SEGID @D @HTYPE @SEGID @D @CTYPE
ENTER V1 VECT XYZ @SEGID @D @HTYPE @SEGID @D @CTYPE
ENTER V2 VECT XYZ @SEGID @D @HTYPE @SEGID @D @CTYPE


!READ TRAJECTORIES 
!-------------------

!TRAJ NUNIT 1  FIRSTU 07 SELEC @WHICH END ORIENT MASS SELEC @WHICH END BEGIN 1 SKIP 1
TRAJ NUNIT 1  FIRSTU 07 SELEC SEGID N1 .or. SEGID N2 END ORIENT MASS BEGIN 1 SKIP 1



!MANIPULATE AND WRITE SERIES (NORMALIZE, P2, AND FFT)
!----------------------------------------------------

!NORMALIZE
MANTIME @D8X RATIO @D8R
MANTIME @D8Y RATIO @D8R
MANTIME @D8Z RATIO @D8R
!CLONE THE TIME SERIES
MANTIME @D8A COPY @D8X
MANTIME @D8B COPY @D8Y
MANTIME @D8C COPY @D8Z
MANTIME @D8D COPY @D8X
MANTIME @D8E COPY @D8Y
MANTIME @D8F COPY @D8Z
!SQUARE SOME
MANTIME @D8X SQUARE
MANTIME @D8Y SQUARE
MANTIME @D8Z SQUARE

MANTIME @D8D KMULT @D8B 
MANTIME @D8E KMULT @D8C
MANTIME @D8F KMULT @D8A

EDIT @D8X VECCOD 6

OPEN WRITE CARD UNIT 01 NAME vector_components.dat
WRITE @D8X UNIT 01 DUMB TIME
* TITLE
*

MANTIME V1 NORMAL
MANTIME V2 NORMAL
CORFUN  V1 V2 FFT P2

IF @CTYPE .EQ. C1' THEN
		SET CTYPE C1P
		SET HTYPE H1P
ENDIF

OPEN WRITE CARD UNIT 02 NAME corel_@S_@run_@SEGID_@RESID_@CTYPE@HTYPE.dat
WRITE CORREL DUMB TIME UNIT 2
* TITLE
*
END

STOP